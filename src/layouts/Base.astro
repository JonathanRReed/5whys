---
import { siteConfig, baseSchemas } from "../config/site";
import Seo from "../components/Seo.astro";
import { ClientRouter } from "astro:transitions";
import Navigation from "../components/Navigation";
import "../styles/globals.css";

const {
  title = siteConfig.siteName,
  description = siteConfig.description,
  theme = "night",
  image = siteConfig.ogImage,
  noindex = false,
  canonical,
  type = "website",
  structuredData = [],
  breadcrumbs = [{ label: "Home", href: "/" }],
} = Astro.props;

const htmlTheme =
  theme === "moon" ? "moon" : theme === "dawn" ? "dawn" : undefined;

const canonicalUrl =
  canonical ?? new URL(Astro.url.pathname, siteConfig.siteUrl).toString();
const breadcrumbList = breadcrumbs.map(
  (crumb: { label: string; href: string }, index: number) => ({
    "@type": "ListItem",
    position: index + 1,
    name: crumb.label,
    item: new URL(crumb.href, siteConfig.siteUrl).toString(),
  }),
);

const breadcrumbSchema =
  breadcrumbList.length > 1
    ? {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        itemListElement: breadcrumbList,
      }
    : null;

const pageSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "@id": `${canonicalUrl}#webpage`,
  url: canonicalUrl,
  name: title,
  description,
  inLanguage: "en-US",
  isPartOf: {
    "@id": baseSchemas.website["@id"],
  },
};

const additionalSchemas = Array.isArray(structuredData)
  ? structuredData
  : [structuredData];
const schemaPayload = [
  baseSchemas.website,
  baseSchemas.creator,
  pageSchema,
  ...(breadcrumbSchema ? [breadcrumbSchema] : []),
  ...additionalSchemas.filter(Boolean),
];
---

<html lang="en" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script is:inline>
      const storageKey = "career-tools-theme";
      const root = document.documentElement;
      const applyThemeEarly = (nextTheme) => {
        if (nextTheme === "moon" || nextTheme === "dawn") {
          root.dataset.theme = nextTheme;
          if (document.body) document.body.dataset.theme = nextTheme;
          // Ensure UA widgets (scrollbars, form controls) match
          try {
            root.style.colorScheme = "light";
          } catch {}
        } else {
          root.removeAttribute("data-theme");
          if (document.body) document.body.removeAttribute("data-theme");
          try {
            root.style.colorScheme = "dark";
          } catch {}
        }
      };

      const getTheme = () => {
        try {
          const cookieMatch = document.cookie.match(
            new RegExp("(^|; )" + storageKey + "=([^;]*)"),
          );
          const fromCookie = cookieMatch?.[2];
          if (
            fromCookie === "night" ||
            fromCookie === "moon" ||
            fromCookie === "dawn"
          )
            return fromCookie;
        } catch {}
        try {
          const stored = window.localStorage.getItem(storageKey);
          if (stored === "night" || stored === "moon" || stored === "dawn")
            return stored;
        } catch {}
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        return prefersDark ? "night" : "dawn";
      };

      const syncTheme = () => {
        // Temporarily disable transitions to avoid flashing during theme apply
        let styleEl;
        try {
          styleEl = document.createElement("style");
          styleEl.id = "theme-transitions-off";
          styleEl.textContent = "*{transition: none !important}";
          document.head.appendChild(styleEl);
        } catch {}

        applyThemeEarly(getTheme());

        // Re-enable transitions on next frame
        try {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              if (styleEl && styleEl.parentNode)
                styleEl.parentNode.removeChild(styleEl);
            });
          });
        } catch {}
      };

      // Apply before paint
      try {
        syncTheme();
      } catch {}
      // Ensure correct theme after transitions/prefetch swaps
      document.addEventListener("astro:before-swap", syncTheme);
      document.addEventListener("astro:after-swap", syncTheme);
      document.addEventListener("astro:page-load", syncTheme);
    </script>
    <Seo
      title={title}
      description={description}
      image={image}
      noindex={noindex}
      canonical={canonicalUrl}
      type={type}
      structuredData={schemaPayload}
    />
    <link rel="icon" href="/favicon.webp" type="image/webp" />
    <ClientRouter />
  </head>
  <body
    class="min-h-screen bg-background text-foreground transition-colors duration-300"
  >
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:z-50 focus:rounded-full focus:bg-[hsl(var(--primary))] focus:px-4 focus:py-2 focus:text-[hsl(var(--primary-foreground))]"
    >
      Skip to main content
    </a>
    <!-- Subtle grain texture overlay for premium matte finish -->
    <div
      aria-hidden="true"
      class="pointer-events-none fixed inset-0 z-50 opacity-[0.015]"
      style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noise%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.85%22 numOctaves=%224%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noise)%22/%3E%3C/svg%3E');"
    >
    </div>
    <div class="relative flex min-h-screen flex-col">
      <Navigation
        client:load
        currentPath={Astro.url.pathname}
        transition:persist
      />
      <main
        id="main-content"
        class="relative z-10 flex-1"
        transition:name="page-content"
      >
        <slot />
      </main>
      <footer
        class="relative z-10 mx-auto mt-12 w-full max-w-6xl rounded-3xl border border-[hsl(var(--border)/0.35)] bg-[hsl(var(--overlay)/0.2)] px-6 py-5 text-center text-sm text-muted-foreground shadow-[0_20px_60px_-34px_hsl(var(--background)/0.92)] transition-colors duration-300"
      >
        <div>
          Made by <span class="font-medium text-foreground"
            >Jonathan R Reed</span
          > · Cybersecurity & AI developer, red team specialist.
        </div>
        <nav
          aria-label="Related projects"
          class="mt-2 flex flex-wrap items-center justify-center gap-x-1 gap-y-1"
        >
          <a
            href="https://jonathanrreed.com/projects/"
            class="font-semibold text-foreground transition-colors hover:text-accent"
            >Jonathan Reed portfolio</a
          >
          <span class="text-muted-foreground/60">·</span>
          <a
            href="https://semesterbuild.jonathanrreed.com/"
            class="font-semibold text-foreground transition-colors hover:text-accent"
            >Semester Build</a
          >
          <span class="text-muted-foreground/60">·</span>
          <a
            href="https://dev-tools.helloworldfirm.com/"
            class="font-semibold text-foreground transition-colors hover:text-accent"
            >Simple Dev Tools</a
          >
        </nav>
      </footer>
      <script is:inline>
        // Scroll Reveal Observer
        (function () {
          if (
            typeof window === "undefined" ||
            typeof IntersectionObserver === "undefined"
          )
            return;

          const initReveal = () => {
            const observer = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (entry.isIntersecting) {
                    entry.target.classList.add("visible");
                  }
                });
              },
              {
                threshold: 0.1,
                rootMargin: "0px 0px -50px 0px",
              },
            );

            document
              .querySelectorAll(".reveal, .reveal-stagger")
              .forEach((el) => {
                observer.observe(el);
              });
          };

          // Run on initial load
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initReveal);
          } else {
            initReveal();
          }

          // Re-run after Astro page transitions
          document.addEventListener("astro:page-load", initReveal);
        })();

        // Cursor Spotlight Tracking
        (function () {
          if (typeof window === "undefined") return;

          const initSpotlight = () => {
            document.querySelectorAll(".cursor-spotlight").forEach((el) => {
              el.addEventListener("mousemove", (e) => {
                const rect = el.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                el.style.setProperty("--mouse-x", x + "%");
                el.style.setProperty("--mouse-y", y + "%");
              });
            });
          };

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initSpotlight);
          } else {
            initSpotlight();
          }

          document.addEventListener("astro:page-load", initSpotlight);
        })();
      </script>
      <script is:inline>
        (function () {
          if (typeof window === "undefined") return;

          const ascii = `
    ___  ________  ________     
   |\\  \\|\\   __  \\|\\   __  \\    
   \\ \\  \\ \\  \\|\\  \\ \\  \\|\\  \\   
 __ \\ \\  \\ \\   _  _\\ \\   _  _\\  
|\\  \\\\_\\  \\ \\  \\\\  \\\\ \\  \\\\  \\|
\\ \\________\\ \\__\\\\ _\\\\ \\__\\\\ _\\
 \\|________|\\|__|\\|__|\\|__|\\|__|
                                
                                
                                
          `;

          console.log(ascii);
          console.log("Hey there. Interested in code");
          console.log("Check out my GitHub: https://github.com/JonathanRReed");
          console.log("Most of my sites repos are open source.");
        })();
      </script>
    </div>
  </body>
</html>
